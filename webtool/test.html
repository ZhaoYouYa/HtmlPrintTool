@{
    Layout = null;
    }
    
    <!DOCTYPE html>
    
    <html>
    
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>Agv呼叫</title>
        <script type="text/javascript">
    
    
            var UserNo = '@Session["UserNo"]'
        </script>
        <style type="text/css">
            [v-cloak] {
                display: none !important
            }
    
            #app {
                text-align: center;
                font-size: 25px;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
    
            }
    
            .n-data-table .n-data-table-th {
                background-color: cornflowerblue !important;
            }
    
            .n-tree .n-tree-node.n-tree-node--disabled .n-tree-node-content {
                color: goldenrod !important;
            }
    
            /* .n-input {
                --n-border: none !important;
            } */
    
            td .n-select .n-base-selection {
                --n-border: none !important;
            }
    
            .n-input__textarea-el {
                font-weight: inherit;
            }
    
            table {
                border-collapse: collapse;
            }
    
            tr {
                border: 1px solid black;
            }
    
            td {
                border-right: 1px solid black;
                text-align: center
            }
    
            span {
                line-height: 35px;
            }
    
            .slash {
                /* width: 100px;
                    height: 50px;
                    background-color: #bbb; */
                /* background-color: #bbb; */
                background-color: black;
                position: relative;
                padding: 0 !important;
            }
    
            .slash::before {
                content: '';
                display: block;
                width: 100%;
                height: 100%;
                background-color: white;
                clip-path: polygon(0px 0.5px, 0px 100%, calc(100% - 0.5px) calc(100% + 0.5px));
                position: absolute;
                top: 0;
            }
    
            .slash::after {
                content: '';
                display: block;
                width: 100%;
                height: 100%;
                background-color: white;
                clip-path: polygon(100% calc(100% - 0.5px), 100% 0px, 0px -0.5px);
                position: absolute;
                top: 0;
            }
    
            /* n-input:focus {
                  background-color: aquamarine;
                } */
        </style>
    </head>
    
    <body>
        <div id="app" v-cloak>
    
            <n-config-provider :locale="zhCN" :date-locale="dateZhCN">
                <!-- <div style="margin-top: 20px;margin-bottom: 20px;color: gray;font-weight: bold;">
                    *鼠标左键点击输入框,进行参数输入;鼠标右键点击张力配重(输入)、拉丝模具(输入)表格,可打开对话框;鼠标左键移入备注,可以增加减少备注行数;鼠标右键点击相应备注行,可切换是否加粗
                  </div> -->
                <div style="display: flex;flex-direction: column;height: 100vh;">
                    <div style="flex:0 0 auto">
                        <n-space justify="start">
                            <n-button type="warning" style="margin-left: 10px;" v-on:click="reset">
                                重置
                            </n-button>
                        </n-space>
    
                        <div style="margin-left: 20%;width: 60%;margin-bottom: 20px;">
                            <n-space :size="0" justify="space-between">
                                <n-button size="large" type="info" style="width: 200px;margin-top: 12px;font-size: 20px;"
                                    v-on:click="genAgvSchedulingTask(Z1,Z2,l1_d)">
                                    呼叫空货架
                                </n-button>
                                <div style="margin-top: 8px;font-size: 30px;">
                                    <n-dropdown trigger="hover" :options="options" style="font-size: 20px;" inverted
                                        size="huge" v-on:select="dpmS1">
                                        <n-input placeholder="请输入起始站点或区域" style="font-size: 20px;" v-model:value="Z1">
                                        </n-input>
                                    </n-dropdown>
    
    
                                </div>
                                <div style="font-size: 35px; font-weight: bold;" v-on:click="()=>{var te = Z1;Z1=Z2;Z2=te}">
                                    <div :style="l1_d?'color:gray':'color:green'">
                                       {{l1_d?"-->":"<--"}}
                                    </div>
                                    
                                </div>
    
                                <div style="margin-top: 12px">
                                    <n-dropdown trigger="hover" :options="options" style="font-size: 20px;" inverted
                                        size="huge" v-on:select="dpmS2">
                                        <n-input style="font-size: 20px;" placeholder="请输入目的站点或区域" v-model:value="Z2">
    
                                        </n-input>
                                    </n-dropdown>
    
                                </div>
                            </n-space>
                            <div style="height: 30px;">
    
                            </div>
                            <n-space :size="0" justify="space-between">
                                <n-button size="large" type="info" style="width: 200px;margin-top: 12px;font-size: 20px;"
                                    v-on:click="genAgvSchedulingTask(Z3,Z4,l2_d)">
                                    运送成品
                                </n-button>
                                <div style="margin-top: 12px">
                                    <n-dropdown trigger="hover" :options="options" style="font-size: 20px;" inverted
                                        size="huge" v-on:select="dpmS3">
                                        <n-input placeholder="请输入起始站点或区域" style="font-size: 20px;" v-model:value="Z3">
    
                                        </n-input>
                                    </n-dropdown>
                                </div>
                                <div style="font-size: 35px; font-weight: bold;"  v-on:click="()=>{var te = Z3;Z3=Z4;Z4=te}">
                                    <div :style="l2_d?'color:gray':'color:green'">
                                       {{l2_d?"-->":"<--"}}
                                    </div>
                                    
                                </div>
    
                                <div style="margin-top: 12px">
                                    <n-dropdown trigger="hover" :options="options2" style="font-size: 20px;" inverted
                                        size="huge" v-on:select="dpmS4">
                                        <n-input placeholder="请输入目的站点或区域" style="font-size: 20px;" v-model:value="Z4">
    
                                        </n-input>
                                    </n-dropdown>
                                </div>
                            </n-space>
                        </div>
                    </div>
                    <div style="flex-grow: 1;">
                        <n-data-table :columns="columns" remote :data="data" striped :loading="loading"
                            :pagination="pagination" v-on:update:page="PageChange" flex-height style="height:100%;">
    
                        </n-data-table>
                    </div>
                </div>
    
    
    
                <!-- <div style="font-size: 35px;color: black;background-color:#bd40ff;border-radius: 10px;text-align: left;padding-left: 20px;">
                    任务列表
                </div> -->
    
    
    
    
            </n-config-provider>
    
    
        </div>
    </body>
    
    </html>
    <script type="text/javascript" src="/Scripts/vue3.2.37.global.js"></script>
    <script type="text/javascript" src="/Scripts/naive-ui2.30.8.js"></script>
    <script>
    
        let mouseHelpF = () => { }
    
        // 对Date的扩展，将 Date 转化为指定格式的String
        // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
        // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
        // 例子：
        // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
        // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
        Date.prototype.Format = function (fmt) {
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "H+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return (false);
        }
        function jsonDateFormatForSeconds(jsonDate) {
            try {
                //返回json格式日期，例如：/Date(1251779696000)/，转化之前应该为：1509-9-1 12:34:56
                var date = new Date(parseInt(jsonDate.replace("/Date(", "").replace(")/", ""), 10));    //默认取10位，包含年月日时分秒及最后的微秒
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var day = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                //var milliseconds = date.getMilliseconds();
                //return date.getFullYear() + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds + "." + milliseconds;
                return date.getFullYear() + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds;
            } catch (ex) {
                return null;
            }
    
        }
        function jsonDateFormat(jsonDate) {
            try {
                //返回json格式日期，例如：/Date(1251779696000)/，转化之前应该为：1509-9-1 12:34:56.111
                var date = new Date(parseInt(jsonDate.replace("/Date(", "").replace(")/", ""), 10));    //默认取10位，包含年月日时分秒及最后的微秒
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var day = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                var milliseconds = date.getMilliseconds();
                //return date.getFullYear() + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds + "." + milliseconds;
                return date.getFullYear() + "-" + month + "-" + day;
            } catch (ex) {
                return null;
            }
        };
        function GetPowerButtonList(P_id) {
    
            fetch(`/User/GetPowerButtonList?P_id=${P_id}`).then(resp => resp.json()).then(data => {
    
                var Data = [];
                var Count = data.rows.length;
                for (var i = 0; i < Count; i++) {
                    thisApp.Authority[`${data.rows[i].B_id}`] = true
                    //Data.push({ "B_code": data.rows[i].B_code, "B_id": data.rows[i].B_id, "B_name": data.rows[i].B_name, "B_icon": data.rows[i].B_icon, "B_title": data.rows[i].B_title })
                }
            })
    
        }
    
        function GetToDayWorkDay() {
            let today = new Date()
            let hours = today.getHours()
            if (hours > 0 && hours < 8) {
                today.setDate(today.getDate() - 1)
            }
            return today.Format('yyyy-MM-dd HH:mm:ss')
        }
        var thisApp = null
        var TTime = null
        const { message, notification, dialog } = naive.createDiscreteApi(["message", "notification", "dialog"]);
        const App = {
            data() {
                return {
                    zhCN: naive.zhCN,
                    dateZhCN: naive.dateZhCN,
                    loading: true,
                    pagination: Vue.reactive({
                        page: 1,
                        pageSize: 20,
                        pageCount: 1,
                        prefix({ itemCount }) {
                            return `共计${itemCount}`
                        }
    
                    }),
                    filterOptionValue: 'All',
                    currentPage: 1,
                    columns: [
                        { title: "任务编号/错误原因", key: "taskCode", width: 200 },
                        { title: "AGV编号", key: "robotCode", width: 100 },
                        { title: "起始", key: "positionS" },
                        { title: "目的", key: "positionE" },
                        {
                            title: "呼叫人", key: "userName", filter: "default",
                            filterOptionValue: null,
                            renderFilterMenu: ({ hide }) => {
                                return Vue.h(
                                    naive.NSpace,
                                    { style: { padding: "12px" }, vertical: true },
                                    {
                                        default: () => [
                                            Vue.h(
                                                naive.NButton,
                                                {
                                                    onClick: () => {
                                                        thisApp.filterOptionValue = "Me";
                                                        thisApp.PageChange(thisApp.currentPage)
                                                        hide()
                                                    }
                                                },
                                                { default: () => "仅显示本人" }
                                            ),
                                            Vue.h(
                                                naive.NButton,
                                                {
                                                    onClick: () => {
                                                        thisApp.filterOptionValue = "All";
                                                        thisApp.PageChange(thisApp.currentPage)
                                                        hide()
                                                    }
                                                },
                                                { default: () => "显示全部" }
                                            )
    
                                        ]
                                    }
                                );
                            }
    
                        },
                        { title: "任务状态", key: "taskStatus" },
                        { title: "呼叫时间", key: "callTime" },
                        { title: "开始时间", key: "startTime" },
                        { title: "结束时间", key: "endTime" },
                        {
    
                            title: "操作", key: "action", render(row) {
                                // return Vue.h(
                                // 	naive.NButton,
                                // 	{
                                // 		onclick:()=>{thisApp.cancelTask(row.taskCode)} ,
                                // 		type: "warning"
                                // 	},
                                // 	{ default: () => "取消任务" }
                                // )
                                if (['错误', '取消', '结束'].includes(row.taskStatus)) {
                                    return ""
                                } else {
                                    return Vue.h(
                                        naive.NButton,
                                        {
                                            onclick: () => { thisApp.cancelTask(row.taskCode) },
                                            type: "warning"
                                        },
                                        { default: () => "取消任务" }
                                    )
    
                                }
    
                                //return row.taskStatus
                            }
                        }
                    ],
                    data: [],
                    Z1: 'A',
                    Z2: '@ViewBag.CurrentSite',
                    Z3: '@ViewBag.CurrentSite',
                    Z4: '',
                    options: [
                        {
                            label: '空托盘区A',
                            key: 'A',
                        },
                        {
                            label: '整形区Z',
                            key: "Z"
                        },
                        {
                            label: '潮湿区CS',
                            key: 'CS'
                        },
                        {
                            label: '模库MK1',
                            key: 'MK1'
                        },
                        {
                            label: '模库MK2',
                            key: 'MK2'
                        },
                        {
                            label: '模修MX',
                            key: 'MX'
                        }
                    ],
                    options2: [
                        {
                            label: '空托盘区A',
                            key: 'A',
                        },
                        {
                            label: '整形区Z',
                            key: "Z"
                        },
                        {
                            label: '潮湿区CS',
                            key: 'CS'
                        },
                        {
                            label: '模修MX',
                            key: 'MX'
                        }
    
                    ],
    
                    l1_d:true,
                    l2_d:true
    
                
                }
            },
            computed: {
            },
            watch: {
            },
            methods: {
                PageChange(currentPage) {
                    if (!this.loading) {
                        this.loading = true
    
                        this.currentPage = currentPage
    
                        this.GetTaskList(currentPage)
                    }
    
                },
                reset() {
                    this.Z1 = 'A'
                    this.Z2 = '@ViewBag.CurrentSite'
                    this.Z3 = '@ViewBag.CurrentSite'
                    this.Z4 = ''
                },
                dpmS1(key) {
                    this.Z1 = key
                },
                dpmS2(key) {
                    this.Z2 = key
                },
                dpmS3(key) {
                    this.Z3 = key
                },
                dpmS4(key) {
                    this.Z4 = key
                },
                cancelTask(taskCode) {
                    dialog.warning({
                        title: '警告',
                        content: '将要取消任务，确定吗？',
                        positiveText: '确定',
                        negativeText: '取消',
                        onPositiveClick: () => {
                            fetch(`/Agv/cancelTask?taskCode=${taskCode}`).then(res => res.json()).then(data => {
                                if (data.isSuccess) {
    
                                    dialog.success({
                                        title: '成功',
                                        content: "取消成功！",
                                        positiveText: '确认',
                                    })
    
                                    // data.data = JSON.parse(data.data)
                                    // if (data.data.code != '0') {
                                    // 	dialog.error({
                                    // 		title: '错误',
                                    // 		content: data.data.message,
                                    // 		positiveText: '确认'
                                    // 	})
    
                                    // } else {
                                    // 	dialog.success({
                                    // 		title: '成功',
                                    // 		content: "取消成功！",
                                    // 		positiveText: '确认',
                                    // 	})
    
                                    // }
    
                                } else {
                                    dialog.error({
                                        title: '错误',
                                        content: data.message,
                                        positiveText: '确认'
                                    })
    
                                }
                            })
    
                        },
                    })
                },
    
                genAgvSchedulingTask(ZoneS, ZoneE,isSwap) {
    
                    if(!isSwap) {
                        var te = ZoneS
                        ZoneS = ZoneE
                        ZoneE = te
                    }
                    fetch(`/Agv/genAgvSchedulingTask?ZoneS=${ZoneS}&ZoneE=${ZoneE}`).then(res => res.json()).then(data => {
    
                        if (data.isSuccess) {
                            
    
                            dialog.success({
                                title: '成功',
                                content: data.message,
                                positiveText: '确认',
    
                            })
                        } else {
                            dialog.error({
                                title: '错误',
                                content: data.message,
                                positiveText: '确认'
                            })
                        }
                        clearTimeout(TTime)
                        thisApp.GetTaskList(thisApp.currentPage);
    
    
    
                    })
    
                },
    
                GetTaskList(currentPage) {
                    fetch(`/Agv/GetTaskList?currentPage=${currentPage}&pageSize=20&filter=${this.filterOptionValue}`).then(res => res.json()).then(data => {
                        if (data.isSuccess) {
                            data.data.forEach(e => {
                                if (e.taskStatus == "start") {
                                    e.taskStatus = "开始"
                                } else if (e.taskStatus == "obin") {
                                    e.taskStatus = '出区域'
                                } else if (e.taskStatus == "end") {
                                    e.taskStatus = "结束"
                                } else if (e.taskStatus == "cancle") {
                                    e.taskStatus = "取消"
                                } else if (e.taskStatus == "err") {
                                    e.taskStatus = "错误"
                                }
    
                                const ob = JSON.parse(e.positionCodePath)
                                try {
                                    e.positionS = ob[0].positionCode
                                    e.positionE = ob[1].positionCode
    
                                }
                                catch {
    
                                }
    
    
                            })
                            this.data = data.data
    
                            this.pagination.page = currentPage,
                                this.pagination.pageCount = data.pageCount,
                                this.pagination.itemCount = data.Count
                            this.loading = false
                        }
                        clearTimeout(TTime)
    
                        TTime = setTimeout(() => {
                            thisApp.GetTaskList(thisApp.currentPage)
                        }, 8000);
                    })
                }
    
    
    
    
            },
            mounted() {
                thisApp = this
                var P_id = '@ViewBag.P_id';
                this.GetTaskList(1)
    
            }
        }
        const app = Vue.createApp(App)
    
        app.use(naive)
        app.mount('#app')
    
    </script>